# Visual Architecture Guide

## System Overview Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USER BROWSER                                      â”‚
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                    â”‚   â”‚
â”‚  â”‚  ğŸ“ Enter: "Research quantum computing"                           â”‚   â”‚
â”‚  â”‚  [                                                    ] [Submit]   â”‚   â”‚
â”‚  â”‚                                                                    â”‚   â”‚
â”‚  â”‚  â³ Generating steps... âœ…                                         â”‚   â”‚
â”‚  â”‚  âœ… Step 1: Research agent (Tavily search) running...           â”‚   â”‚
â”‚  â”‚  ğŸ•“ Step 2: Research agent (arXiv search) pending...            â”‚   â”‚
â”‚  â”‚  ğŸ•“ Step 3: Writer agent pending...                             â”‚   â”‚
â”‚  â”‚                                                                    â”‚   â”‚
â”‚  â”‚  [â• Step 1] Expand to see details                               â”‚   â”‚
â”‚  â”‚    â”œâ”€ Called research_agent                                       â”‚   â”‚
â”‚  â”‚    â””â”€ <Found 5 sources on Tavily...>                            â”‚   â”‚
â”‚  â”‚                                                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â†‘ â†“                                           â”‚
â”‚                    HTTP polling (2 seconds)                                â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         HTTP                          â†‘ â†“                          HTTP
    POST /generate_report      GET /task_progress/id       GET /task_status/id
              â”‚                         â”‚                            â”‚
              â†“                         â†“                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        FASTAPI SERVER                                     â”‚
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ @app.post("/generate_report")                                     â”‚   â”‚
â”‚  â”‚ â”œâ”€ Validate input (Pydantic)                                      â”‚   â”‚
â”‚  â”‚ â”œâ”€ Create task in DB                                             â”‚   â”‚
â”‚  â”‚ â”œâ”€ Initialize task_progress[id]                                  â”‚   â”‚
â”‚  â”‚ â”œâ”€ Call planner_agent()                                          â”‚   â”‚
â”‚  â”‚ â”œâ”€ Spawn worker thread                                           â”‚   â”‚
â”‚  â”‚ â””â”€ Return {task_id: "uuid"} immediately â† Non-blocking!         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ @app.get("/task_progress/{id}")                                  â”‚   â”‚
â”‚  â”‚ â””â”€ Return task_progress[id] â† Fast in-memory lookup              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ @app.get("/task_status/{id}")                                    â”‚   â”‚
â”‚  â”‚ â””â”€ Query DB, return task + result                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€ Planner (worker thread)
         â”‚       â”‚
         â”‚       â†“
         â”‚   [Generate 7-step plan]
         â”‚
         â”œâ”€ Workflow Executor (worker thread)
         â”‚       â”‚
         â”‚       â”œâ”€ For step 1-7:
         â”‚       â”‚       â”‚
         â”‚       â”‚       â”œâ”€ Update task_progress
         â”‚       â”‚       â”‚
         â”‚       â”‚       â”œâ”€ Call Agent
         â”‚       â”‚       â”‚   â”œâ”€ Research Agent
         â”‚       â”‚       â”‚   â”œâ”€ Writer Agent
         â”‚       â”‚       â”‚   â””â”€ Editor Agent
         â”‚       â”‚       â”‚
         â”‚       â”‚       â”œâ”€ Agent calls Tools
         â”‚       â”‚       â”‚   â”œâ”€ Tavily API
         â”‚       â”‚       â”‚   â”œâ”€ arXiv API
         â”‚       â”‚       â”‚   â””â”€ Wikipedia API
         â”‚       â”‚       â”‚
         â”‚       â”‚       â”œâ”€ Get results
         â”‚       â”‚       â”‚
         â”‚       â”‚       â”œâ”€ Format output
         â”‚       â”‚       â”‚
         â”‚       â”‚       â””â”€ Update task_progress
         â”‚       â”‚
         â”‚       â””â”€ Update DB with final result
         â”‚
         â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚          DATABASE (PostgreSQL)                              â”‚
    â”‚                                                             â”‚
    â”‚  Table: tasks                                              â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚  â”‚ id (PK)  â”‚ prompt â”‚ status â”‚ result â”‚ timestamps  â”‚   â”‚
    â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
    â”‚  â”‚ uuid-123 â”‚ "Qu..." â”‚ "done" â”‚ {...} â”‚ 2025-11-11 â”‚   â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â”‚                                                             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Request Flow Timing Diagram

```
Time  Main Thread             Worker Thread             Frontend         Database
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T0    POST /generate_report
      â”‚
      â”œâ”€ Validate            âœ“
      â”œâ”€ Create task         âœ“                                        Write: Task
      â”œâ”€ Init progress       âœ“
      â”œâ”€ Get plan            âœ“
      â”‚
      â”œâ”€ Spawn thread        âœ“
      â”‚                      â””â”€ Run workflow
      â””â”€ Return task_id immediately
                             â”‚
                             â”œâ”€ Step 1: Research
                             â”‚  â””â”€ Call Tavily
                             â”‚
T1                          â”‚                         GET /progress    Read: progress
                             â”œâ”€ Update progress       â”œâ”€ Return steps
                             â”‚                        â””â”€ Display UI
                             â”‚
                             â”œâ”€ Step 2: Research
                             â”‚  â””â”€ Call arXiv
                             â”‚
T2                          â”‚                         GET /progress    Read: progress
                             â”œâ”€ Update progress       â”œâ”€ Return steps
                             â”‚                        â””â”€ Display UI
                             â”‚
                             â”œâ”€ Steps 3-7...
                             â”‚  (similar pattern)
                             â”‚
T3                          â””â”€ Update DB
                               Save result                             Write: Done
                               End thread
                             
T4                                                    GET /status      Read: DB
                                                      â”œâ”€ Return result
                                                      â””â”€ Display report

Total time: 30-300 seconds depending on agent complexity
```

---

## State Progression Diagram

```
[In-Memory State] â† Dual Management â†’ [Database State]

Initial:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ task_progress = {}      â”‚       â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         â”‚       â”‚       â”‚ Task DB: None    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    (API creates task)
                                  â”‚
After Task Creation:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ task_progress[id] = {          â”‚       â”‚ Task(id, prompt,         â”‚
â”‚   steps: []                    â”‚       â”‚ status="running",        â”‚
â”‚ }                              â”‚       â”‚ result=null)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
            (Steps initialized)
                                  â”‚
After Step 1:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ task_progress[id] = {          â”‚       â”‚ Task unchanged           â”‚
â”‚   steps: [{                    â”‚       â”‚ (DB not updated yet)     â”‚
â”‚     title: "Research...",      â”‚       â”‚                          â”‚
â”‚     status: "done",            â”‚       â”‚                          â”‚
â”‚     substeps: [{...}]          â”‚       â”‚                          â”‚
â”‚   }, ...]                      â”‚       â”‚                          â”‚
â”‚ }                              â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
        (Updates every step)
                                  â”‚
After All Steps:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ task_progress[id] = {          â”‚       â”‚ Task(status="done",      â”‚
â”‚   steps: [{...}, ...] (all 7)  â”‚       â”‚ result={"html_report":   â”‚
â”‚ }                              â”‚       â”‚ "# Title\n...", ...})    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
    (Frontend reads from DB now)
                                  â”‚
Final Display:
                                          Frontend renders report
                                          from DB result
```

---

## Agent Routing Decision Tree

```
executor_agent_step(step_title)
â”‚
â”œâ”€ "research" in step_title.lower()
â”‚  â”‚
â”‚  â””â”€â†’ research_agent(prompt)
â”‚      â”œâ”€ Has tools: [tavily, arxiv, wikipedia]
â”‚      â”œâ”€ LLM decides which to use
â”‚      â”œâ”€ Returns research findings
â”‚      â””â”€ Output: "Based on search: ..."
â”‚
â”œâ”€ "draft" in step_title.lower() OR "write" in step_title.lower()
â”‚  â”‚
â”‚  â””â”€â†’ writer_agent(prompt)
â”‚      â”œâ”€ Has NO tools
â”‚      â”œâ”€ System prompt: "Academic writer"
â”‚      â”œâ”€ Formats as Markdown
â”‚      â”œâ”€ Includes [1], [2] citations
â”‚      â””â”€ Output: "# Title\n\n## Abstract\n..."
â”‚
â”œâ”€ "revise" in step_title.lower() OR "edit" in step_title.lower()
â”‚  â”‚
â”‚  â””â”€â†’ editor_agent(prompt)
â”‚      â”œâ”€ Has NO tools
â”‚      â”œâ”€ System prompt: "Academic editor"
â”‚      â”œâ”€ Preserves citations
â”‚      â”œâ”€ Improves clarity
â”‚      â””â”€ Output: "# Title\n\n## Abstract\n..."
â”‚
â””â”€ ELSE
   â””â”€â†’ ValueError("Unknown step type")
```

---

## Tool Calling Sequence

```
Agent receives task:
â”‚
â”œâ”€ Get tool definitions:
â”‚  â”œâ”€ tavily_search_tool
â”‚  â”‚  â””â”€ Searches the web for query
â”‚  â”œâ”€ arxiv_search_tool
â”‚  â”‚  â””â”€ Searches arXiv for academic papers
â”‚  â””â”€ wikipedia_search_tool
â”‚     â””â”€ Gets Wikipedia summaries
â”‚
â”œâ”€ Send to LLM:
â”‚  â”œâ”€ Messages: [user_prompt]
â”‚  â”œâ”€ Model: openai:gpt-4.1-mini
â”‚  â”œâ”€ Tools: [definitions]
â”‚  â””â”€ tool_choice: "auto"
â”‚
â”œâ”€ LLM thinks:
â”‚  â”œâ”€ "I need to search the web"
â”‚  â”œâ”€ Decision: Use tavily_search_tool
â”‚  â””â”€ Arguments: {query: "quantum computing"}
â”‚
â”œâ”€ Tool execution:
â”‚  â”œâ”€ ğŸ“¡ HTTP POST https://api.tavily.com
â”‚  â”œâ”€ Returns: [{title: "...", content: "...", url: "..."}, ...]
â”‚  â””â”€ Max retries: 5, backoff: 0.6
â”‚
â”œâ”€ Back to LLM:
â”‚  â”œâ”€ "Here are the results"
â”‚  â”œâ”€ LLM synthesizes
â”‚  â””â”€ Writes summary
â”‚
â””â”€ Return to agent:
   â””â”€ "Based on these sources: ..."
```

---

## Error Handling Flow

```
Error in tool call
â”‚
â””â”€â†’ Return {"error": "message"}
   (graceful degradation)
   â”‚
   â””â”€â†’ Agent sees error
      â”‚
      â””â”€â†’ Mentions in output or tries alternate tool
         â”‚
         â””â”€â†’ Workflow continues (not fatal)

Error in agent call
â”‚
â””â”€â†’ Catch in executor_agent_step()
   â”‚
   â””â”€â†’ Return error message
      â”‚
      â””â”€â†’ Service layer catches
         â”‚
         â”œâ”€â†’ Mark step as "error"
         â”œâ”€â†’ Update task_progress
         â”œâ”€â†’ Update DB: status = "error"
         â””â”€â†’ Terminate gracefully

Frontend sees error
â”‚
â””â”€â†’ Display error message in UI
   â””â”€â†’ User can investigate logs
```

---

## Thread Lifecycle

```
Main Thread (FastAPI Server)
â”‚
â”œâ”€ Continuous loop: Accept requests
â”‚  â”‚
â”‚  â”œâ”€ Request 1: POST /generate_report
â”‚  â”‚  â””â”€ Spawn Worker Thread 1
â”‚  â”‚
â”‚  â”œâ”€ Request 2: GET /task_progress/1
â”‚  â”‚  â””â”€ Return from memory (fast)
â”‚  â”‚
â”‚  â”œâ”€ Request 3: POST /generate_report
â”‚  â”‚  â””â”€ Spawn Worker Thread 2
â”‚  â”‚
â”‚  â”œâ”€ Request 4: GET /task_progress/2
â”‚  â”‚  â””â”€ Return from memory (fast)
â”‚  â”‚
â”‚  â””â”€ Continue accepting...

Worker Thread 1                          Worker Thread 2
â”‚                                        â”‚
â”œâ”€ Execute workflow for task 1           â”œâ”€ Execute workflow for task 2
â”‚  â”œâ”€ Step 1: Research                  â”‚  â”œâ”€ Step 1: Research
â”‚  â”œâ”€ Step 2: Write                     â”‚  â”œâ”€ Step 2: Write
â”‚  â”œâ”€ Step 3: Edit                      â”‚  â”œâ”€ Step 3: Edit
â”‚  â””â”€ Update DB                         â”‚  â””â”€ Update DB
â”‚                                        â”‚
â””â”€ Thread terminates                     â””â”€ Thread terminates

Result: Multiple tasks run concurrently!
```

---

## Memory Model

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Python Process Memory                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ MAIN THREAD                                           â”‚  â”‚
â”‚  â”‚ â”œâ”€ FastAPI app instance                              â”‚  â”‚
â”‚  â”‚ â”œâ”€ Database connections (SQLAlchemy)                â”‚  â”‚
â”‚  â”‚ â””â”€ Request handlers                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â†‘                                                   â”‚
â”‚           â”‚ (shares)                                         â”‚
â”‚           â†“                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ SHARED IN-MEMORY STATE                                â”‚  â”‚
â”‚  â”‚                                                       â”‚  â”‚
â”‚  â”‚ task_progress = {                                    â”‚  â”‚
â”‚  â”‚   "task-uuid-123": {                                 â”‚  â”‚
â”‚  â”‚     "steps": [                                       â”‚  â”‚
â”‚  â”‚       {"title": "...", "status": "done", ...}        â”‚  â”‚
â”‚  â”‚     ]                                                â”‚  â”‚
â”‚  â”‚   },                                                 â”‚  â”‚
â”‚  â”‚   "task-uuid-456": {                                 â”‚  â”‚
â”‚  â”‚     "steps": [...]                                   â”‚  â”‚
â”‚  â”‚   }                                                  â”‚  â”‚
â”‚  â”‚ }                                                    â”‚  â”‚
â”‚  â”‚                                                       â”‚  â”‚
â”‚  â”‚ âš ï¸ POTENTIAL RACE CONDITION                          â”‚  â”‚
â”‚  â”‚ (Multiple threads updating simultaneously)           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â†‘                                                   â”‚
â”‚           â”‚ (updates)                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                                                     â”‚    â”‚
â”‚  â”‚ WORKER THREAD 1    â”‚    WORKER THREAD 2            â”‚    â”‚
â”‚  â”‚ (Task 1)           â”‚    (Task 2)                    â”‚    â”‚
â”‚  â”‚ â”œâ”€ Agent 1         â”‚    â”œâ”€ Agent 1                 â”‚    â”‚
â”‚  â”‚ â”œâ”€ Agent 2         â”‚    â”œâ”€ Agent 2                 â”‚    â”‚
â”‚  â”‚ â”œâ”€ Agent 3         â”‚    â””â”€ Agent 3                 â”‚    â”‚
â”‚  â”‚ â””â”€ Update DB       â”‚    â””â”€ Update DB               â”‚    â”‚
â”‚  â”‚ â””â”€ Terminate       â”‚    â””â”€ Terminate               â”‚    â”‚
â”‚  â”‚                    â”‚                               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“ (persists)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ PostgreSQL Database             â”‚
    â”‚ â”œâ”€ Table: tasks                 â”‚
    â”‚ â”œâ”€ Persistent storage           â”‚
    â”‚ â””â”€ Survives restarts            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow: From Prompt to Report

```
"Explain quantum computing"
         â”‚
         â†“ (POST /generate_report)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Create Task                              â”‚
â”‚    â”œâ”€ id: "uuid-123"                        â”‚
â”‚    â”œâ”€ prompt: "Explain quantum..."          â”‚
â”‚    â”œâ”€ status: "running"                     â”‚
â”‚    â””â”€ result: null                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Plan Generation (Planner Agent)          â”‚
â”‚    â”œâ”€ Sends to: GPT-4o mini                 â”‚
â”‚    â””â”€ Gets: 7-step plan                     â”‚
â”‚       â”œâ”€ Research: Tavily                   â”‚
â”‚       â”œâ”€ Research: arXiv                    â”‚
â”‚       â”œâ”€ Research: Synthesis                â”‚
â”‚       â”œâ”€ Writer: Draft                      â”‚
â”‚       â”œâ”€ Editor: Review                     â”‚
â”‚       â”œâ”€ Writer: Final                      â”‚
â”‚       â””â”€ Done                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Research Phase (Step 1-3)                â”‚
â”‚    â”œâ”€ Tool: Tavily search                   â”‚
â”‚    â”‚  â””â”€ Returns: [web results]             â”‚
â”‚    â”œâ”€ Tool: arXiv search                    â”‚
â”‚    â”‚  â””â”€ Returns: [papers]                  â”‚
â”‚    â”œâ”€ Synthesis                             â”‚
â”‚    â”‚  â””â”€ Returns: [ranked sources]          â”‚
â”‚    â””â”€ Stored in: execution_history          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Writing Phase (Step 4)                   â”‚
â”‚    â”œâ”€ Input: All research findings          â”‚
â”‚    â”œâ”€ Process: GPT-4o mini creates report   â”‚
â”‚    â”œâ”€ Format: Markdown with [1], [2]...     â”‚
â”‚    â””â”€ Output: 1500-3000 word report         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Editing Phase (Step 5-7)                 â”‚
â”‚    â”œâ”€ Input: Draft report                   â”‚
â”‚    â”œâ”€ Process: GPT-4o mini improves         â”‚
â”‚    â”œâ”€ Preserves: All citations              â”‚
â”‚    â””â”€ Output: Polished report               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Save Results                             â”‚
â”‚    â”œâ”€ task.status = "done"                  â”‚
â”‚    â”œâ”€ task.result = {                       â”‚
â”‚    â”‚   "html_report": "# Quantum...",        â”‚
â”‚    â”‚   "history": [...]                     â”‚
â”‚    â”‚ }                                       â”‚
â”‚    â””â”€ DB: updated                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. Display to User                          â”‚
â”‚    â”œâ”€ Frontend detects: status = "done"     â”‚
â”‚    â”œâ”€ Fetches: /task_status                 â”‚
â”‚    â”œâ”€ Renders: Markdown to HTML             â”‚
â”‚    â”œâ”€ Shows: Download buttons               â”‚
â”‚    â””â”€ Displays: Final report                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Scaling from 1 to 100 Tasks

```
Current Architecture (Development):
Task 1 â”€â”€â”
Task 2 â”€â”€â”œâ”€â†’ Single instance, threading
Task 3 â”€â”€â”¤   Works: 1-10 concurrent
Task 4 â”€â”€â”˜

Scaling to Production:
Task 1 â”€â”
Task 2 â”€â”¤
Task 3 â”€â”¤      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
Task 4 â”€â”¼â”€â”€â”€â”€â”€â†’ Load Balancer â”€â”€â”€â”€â”€â†’ FastAPI Server 1 â”‚
... â”€â”€â”€â”€â”¤      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Task 50 â”¤                                               
Task 100â””â”€                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                      â”œâ”€ FastAPI Server 2
                                      â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Message Queueâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”œâ”€ FastAPI Server 3
         â”‚ (RabbitMQ)   â”‚             â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†‘
         â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
         â”‚          â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Redis  â”‚  â”‚PostgreSQLâ”‚
    â”‚ Cache  â”‚  â”‚ Database â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Deployment: Docker Single Container

```
Host Machine:
  .env file
  â”œâ”€ OPENAI_API_KEY=sk-xxxx
  â”œâ”€ TAVILY_API_KEY=tvly-xxxx
  â””â”€ POSTGRES_USER/PASSWORD
  
     docker run -p 8000:8000 -p 5432:5432 \
                --env-file .env \
                agentic-ai

         â”‚
         â†“

Docker Container:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ /entrypoint.sh                                           â”‚
  â”‚                                                          â”‚
  â”‚ â”œâ”€ pg_ctlcluster 17 main start                          â”‚
  â”‚ â”‚  â””â”€ PostgreSQL service starts                         â”‚
  â”‚ â”‚     Listen: 127.0.0.1:5432                            â”‚
  â”‚ â”‚                                                        â”‚
  â”‚ â”œâ”€ Wait for Postgres ready                              â”‚
  â”‚ â”‚  (pg_isready)                                         â”‚
  â”‚ â”‚                                                        â”‚
  â”‚ â”œâ”€ Create role if not exists                            â”‚
  â”‚ â”‚  su -s /bin/bash postgres -c "CREATE USER app..."     â”‚
  â”‚ â”‚                                                        â”‚
  â”‚ â”œâ”€ Create database if not exists                        â”‚
  â”‚ â”‚  su -s /bin/bash postgres -c "CREATE DATABASE appdb"  â”‚
  â”‚ â”‚                                                        â”‚
  â”‚ â”œâ”€ Export DATABASE_URL                                  â”‚
  â”‚ â”‚  "postgresql://app:local@127.0.0.1:5432/appdb"        â”‚
  â”‚ â”‚                                                        â”‚
  â”‚ â””â”€ exec uvicorn main:app --host 0.0.0.0 --port 8000    â”‚
  â”‚    â””â”€ FastAPI server starts                             â”‚
  â”‚       Listen: 0.0.0.0:8000 (all interfaces)             â”‚
  â”‚                                                          â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†‘ â†‘
    mapped ports
         â”‚ â”‚
  8000â”€â”€â”€â”˜ â””â”€â”€â”€5432
  (App)      (DB)
```

---

**For more detailed information, see the other architecture documents!**

